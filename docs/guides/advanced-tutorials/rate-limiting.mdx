---
title: "How to Setup Rate Limit on Services"
description: "Configure rate limiting for services using NGINX"
---

This guide covers implementing rate limits on Qovery services through NGINX customization. Rate limiting helps protect services from abuse. While third-party solutions like Cloudflare are recommended for filtering traffic before it reaches workloads, this tutorial demonstrates cluster-level implementation.

<Warning>
Changing NGINX snippets configuration is an advanced feature and can lead to misconfiguration. Please be careful when changing these settings as it might break the whole NGINX configuration.
</Warning>

## Prerequisites

- Application running on a Qovery managed cluster
- Basic understanding of NGINX rate limiting

## Understanding NGINX Rate Limiting

NGINX rate limiting protects your services by controlling the rate of requests. For detailed information, see [NGINX's official documentation on rate limiting](https://www.nginx.com/blog/rate-limiting-nginx/).

---

## Initial Setup

### Configure Test Service

We'll use `jmalloc/echo-server` Docker image for testing:
- Image: `jmalloc/echo-server`
- Port: 80

<Frame>
  <img src="/images/nginx-rate-limit/service-initial-setup-qovery-screen.png" alt="Service initial setup" />
</Frame>

### Configure NGINX Replicas

Rate limits apply per NGINX instance. For demonstration, set replicas to 1 (not recommended for production):

1. Go to **Cluster Settings** → **Advanced Settings**
2. Find `nginx.controller.replicas`
3. Set value to `1`

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-replicas.png" alt="Set NGINX replicas" />
</Frame>

<Info>
Without rate limits: 100 req/sec × 500 requests = 100% success rate (all HTTP 200 responses)
</Info>

---

## Global Rate Limit Implementation

### Declare at Cluster Level

Configure `nginx.controller.http_snippet`:

```nginx
limit_req_zone "$server_name" zone=global:10m rate=10r/s;
```

**Components:**
- `$server_name`: Rate limit key (can use `$http_x_forwarded_for` for IP-based limits)
- `zone=global:10m`: Zone name with 10MB memory allocation
- `rate=10r/s`: 10 requests per second threshold

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-set-global-rate-in-http-snippet.png" alt="Set global rate in http snippet" />
</Frame>

### Apply Rate Limit

Configure `nginx.controller.server_snippet`:

```nginx
location / {
    limit_req zone=global;
}
```

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-set-global-rate-in-server-snippet.png" alt="Apply global rate in server snippet" />
</Frame>

### Deploy Changes

<Frame>
  <img src="/images/nginx-rate-limit/deploy-cluster-after-advanced-settings-changes.png" alt="Deploy cluster changes" />
</Frame>

### Enhancement with Burst

Adding `burst=20 nodelay;` permits 20-request bursts without delays:

```nginx
location / {
    limit_req zone=global burst=20 nodelay;
}
```

### Test Results

Load test: 100 req/sec for 500 total requests

**Result:**
- 452 HTTP 503 rejections
- 48 HTTP 200 acceptances (~9.6 req/sec)

<Frame>
  <img src="/images/nginx-rate-limit/nginx-logs-rejecting-requests-with-global-rate.png" alt="Global rate limit logs" />
</Frame>

---

## Service-Level Rate Limit

Configure rate limiting at the service level using advanced settings:

**Configuration Settings:**
- `network.ingress.nginx_limit_rps`: Rate in requests/second
- `network.ingress.nginx_limit_rpm`: Rate in requests/minute
- `network.ingress.nginx_limit_burst_multiplier`: Burst multiplier (default: 5)

### Example: 10 Requests/Minute with 2× Burst

<Frame>
  <img src="/images/nginx-rate-limit/service-advanced-settings-set-limit-rpm-and-burst.png" alt="Service-level rate limit" />
</Frame>

<Info>
When both RPM and RPS are set, both rate limits will be enforced simultaneously. Traffic will be restricted based on whichever limit is hit first.
</Info>

### Deploy Service

<Frame>
  <img src="/images/nginx-rate-limit/deploy-service.png" alt="Deploy service with rate limit" />
</Frame>

### Test Results

- 479 HTTP 503 rejections
- 21 HTTP 200 acceptances

<Frame>
  <img src="/images/nginx-rate-limit/nginx-logs-rejecting-requests-with-service-rate.png" alt="Service rate limit logs" />
</Frame>

---

## Custom Header-Based Rate Limiting

Implement rate limiting based on custom HTTP headers.

### Cluster Configuration

Configure `nginx.controller.http_snippet`:

```nginx
map $http_x_qovery_api_key $limit_key {
    default $http_x_qovery_api_key;
    "" "anonymous";
}

limit_req_zone $limit_key zone=qovery_api_limit:10m rate=5r/s;
```

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-set-custom-header-rate-in-http-snippet.png" alt="Custom header rate limit declaration" />
</Frame>

**Details:** Maps HTTP header values to rate limit keys; missing headers default to "anonymous" designation.

### Service Configuration

Configure `network.ingress.nginx_controller_configuration_snippet`:

```nginx
limit_req zone=qovery_api_limit burst=2 nodelay;
```

<Frame>
  <img src="/images/nginx-rate-limit/service-advanced-settings-set-customer-header-rate-limiter-in-configuration-snippet.png" alt="Apply custom header rate limit" />
</Frame>

**Burst Parameter Explanation:**
- `burst=2`: Permits 2 extra requests beyond rate limit during short bursts
- `nodelay`: Disables request queuing; excess requests rejected immediately

### Deploy and Test

<Frame>
  <img src="/images/nginx-rate-limit/deploy-service-with-custom-header-rate-limiter.png" alt="Deploy with custom header rate limit" />
</Frame>

**Test Command:**
```bash
oha -q 100 -n 500 -H "X-QOVERY-API-KEY: benjamin"
```

**Result:**
- 473 HTTP 503 rejections
- 27 HTTP 200 acceptances (~5.4 req/sec with burst)

<Frame>
  <img src="/images/nginx-rate-limit/nginx-logs-rejecting-requests-with-custom-header-in-service-logs.png" alt="Service logs with custom header" />
</Frame>

<Frame>
  <img src="/images/nginx-rate-limit/nginx-logs-rejecting-requests-with-custom-header.png" alt="NGINX logs with custom header" />
</Frame>

---

## Additional Configuration

### Custom HTTP Status Code

Configure `nginx.controller.limit_request_status_code`:
- Default: HTTP 503
- Alternative: HTTP 429 (commonly used for rate limiting)

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-custom-limit-http-status.png" alt="Custom HTTP status code" />
</Frame>

Test results show HTTP 429 responses:

<Frame>
  <img src="/images/nginx-rate-limit/cluster-advanced-settings-custom-limit-http-status-logs.png" alt="HTTP 429 response logs" />
</Frame>

### Connection Limits

Configure `network.ingress.nginx_limit_connections` at service level to limit concurrent connections from single IP addresses.

---

## Summary

<AccordionGroup>
  <Accordion title="Global Rate Limit">
    Applied at cluster level, affects all services. Best for protecting the entire cluster from abuse.
  </Accordion>

  <Accordion title="Service-Level Rate Limit">
    Applied per service using `nginx_limit_rps` or `nginx_limit_rpm`. Best for protecting individual services.
  </Accordion>

  <Accordion title="Header-Based Rate Limit">
    Applied based on custom HTTP headers. Best for API key-based rate limiting and multi-tenant applications.
  </Accordion>

  <Accordion title="Connection Limits">
    Limits concurrent connections per IP. Best for preventing connection exhaustion attacks.
  </Accordion>
</AccordionGroup>

---

## Related Documentation

<CardGroup cols={2}>
  <Card title="Advanced Settings" icon="sliders" href="/configuration/service-advanced-settings">
    Configure service advanced settings
  </Card>

  <Card title="NGINX Configuration" icon="server" href="/integrations/api-gateway-nginx">
    Learn about NGINX ingress
  </Card>

  <Card title="Cluster Configuration" icon="layer-group" href="/configuration/clusters">
    Configure cluster settings
  </Card>

  <Card title="Security Best Practices" icon="shield" href="/security-and-compliance/overview">
    Implement security measures
  </Card>
</CardGroup>
