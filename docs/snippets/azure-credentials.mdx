Qovery needs credentials to manage resources in your Azure subscription. We use a secure service principal approach that avoids storing long-lived credentials.

### Get Your Azure IDs

<Steps>
  <Step title="Find Tenant ID">
    1. Go to [Azure Portal](https://portal.azure.com)
    2. Navigate to **Azure Active Directory**
    3. Click **Overview** in the left sidebar
    4. Copy your **Tenant ID** (also called Directory ID)

    You can also find it directly at: [portal.azure.com/#view/Microsoft_AAD_IAM/TenantProperties.ReactView](https://portal.azure.com/#view/Microsoft_AAD_IAM/TenantProperties.ReactView)

    <Tip>
    The Tenant ID is a GUID that looks like: `12345678-1234-1234-1234-123456789abc`
    </Tip>
  </Step>

  <Step title="Find Subscription ID">
    1. In Azure Portal, go to **Subscriptions**
    2. Click on the subscription you want to use
    3. Copy the **Subscription ID** from the overview page

    You can also find it at: [portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade](https://portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade)

    <Warning>
    Make sure the subscription is **active** and has billing enabled. Qovery cannot create resources in disabled subscriptions.
    </Warning>
  </Step>
</Steps>

### Generate Installation Command

<Steps>
  <Step title="Start Cluster Creation">
    1. Go to [Qovery Console](https://console.qovery.com)
    2. Click **Clusters** in the left sidebar
    3. Click **Create Cluster**
    4. Select **Azure** as the cloud provider
  </Step>

  <Step title="Enter Azure Details">
    1. Enter your **Tenant ID**
    2. Enter your **Subscription ID**
    3. Click **Next**

    Qovery will generate a secure installation command for you.
  </Step>

  <Step title="Copy the Command">
    Copy the generated command to your clipboard.

    <Info>
    This command creates a service principal using Azure's app registration. It's completely secure and you can inspect the script at: [hub.qovery.com/files/create_credentials_azure.sh](https://hub.qovery.com/files/create_credentials_azure.sh)
    </Info>
  </Step>
</Steps>

### Run Installation Script

<Steps>
  <Step title="Open Azure Cloud Shell">
    1. In Azure Portal, click the **Cloud Shell** icon (>_) in the top navigation bar
    2. **Important**: Select **Bash** mode (not PowerShell)

    <Frame>
      <img src="/images/azure-credentials/azure_shell_1.png" alt="Azure Cloud Shell in Bash mode" />
    </Frame>

    <Warning>
    The script must run in **Bash mode**. If you're in PowerShell, click the dropdown and switch to Bash.
    </Warning>
  </Step>

  <Step title="Run the Command">
    1. Paste the command from Qovery into Azure Cloud Shell
    2. Press **Enter**
    3. Review the subscription details displayed
    4. The script will create a service principal and assign necessary permissions

    **Example output:**
    ```bash
    Creating service principal for Qovery...
    Service principal created successfully!
    Assigning Contributor role...
    ✓ Credentials configured successfully

    Subscription ID: 12345678-1234-1234-1234-123456789abc
    Tenant ID: 87654321-4321-4321-4321-cba987654321
    ```
  </Step>

  <Step title="Verify in Qovery">
    The credentials are automatically linked to your Qovery organization.

    <Tip>
    If you have multiple subscriptions, you can specify which one to use by passing it as a parameter to the script.
    </Tip>
  </Step>
</Steps>

<AccordionGroup>
  <Accordion title="What permissions does Qovery need?">
    Qovery requires these Azure permissions to manage your infrastructure:
    - **Contributor Role**: Full access to create and manage resources (AKS, VMs, VNets, Load Balancers, etc.)
    - **Resource Group Management**: Create and manage resource groups
    - **Azure Kubernetes Service**: Create and manage AKS clusters
    - **Virtual Network**: Configure VNets, subnets, NSGs, and NAT Gateways
    - **Compute**: Provision VM Scale Sets for node pools
    - **Storage**: Create and manage Managed Disks for persistent storage
    - **DNS**: Configure DNS zones and records

    The service principal created by the script is assigned the **Contributor** role at the subscription level, which provides all necessary permissions.
  </Accordion>

  <Accordion title="What is a Service Principal?">
    A service principal is an identity created for use with applications, hosted services, and automated tools to access Azure resources. It's similar to a "service account" in other cloud providers.

    **Key benefits:**
    - **Security**: No need to share personal Azure credentials
    - **Scope Control**: Permissions limited to specific subscription
    - **Auditability**: All actions tracked in Azure Activity Log
    - **Revocable**: Can be deleted without affecting user accounts

    The service principal uses certificate-based authentication, which is more secure than password-based authentication.
  </Accordion>

  <Accordion title="How do I rotate credentials?">
    To rotate Azure credentials:
    1. In Azure Portal, go to **Azure Active Directory** → **App registrations**
    2. Find the Qovery service principal (name starts with `qovery-`)
    3. Go to **Certificates & secrets**
    4. Add a new certificate or client secret
    5. Run the Qovery credential creation script again to generate new credentials
    6. Update credentials in Qovery Console
    7. Wait 24 hours to ensure all systems use new credentials
    8. Remove the old certificate/secret in Azure Portal

    <Info>
    Qovery uses certificate-based authentication by default, which is more secure than client secrets.
    </Info>
  </Accordion>

  <Accordion title="Can I use an existing service principal?">
    Yes! If you have an existing service principal with the Contributor role, you can use it instead of creating a new one. However, ensure it has:
    - Contributor role at the subscription level (or at minimum, the resource group where clusters will be created)
    - Certificate or client secret configured
    - No expiration date conflicts with your security policies

    You'll need to manually provide the credentials to Qovery Console instead of using the automated script.
  </Accordion>

  <Accordion title="What if the script fails?">
    **Common issues and solutions:**

    **"Insufficient privileges"**:
    - You need at least "User Access Administrator" or "Owner" role to create service principals
    - Contact your Azure administrator for assistance

    **"PowerShell mode detected"**:
    - The script only runs in Bash mode
    - Click the dropdown in Cloud Shell and select "Bash"

    **"Subscription not found"**:
    - Verify the Subscription ID is correct
    - Ensure the subscription is active and not disabled
    - Check you have access to the subscription

    **"Tenant ID mismatch"**:
    - Verify you're logged into the correct Azure tenant
    - Some accounts have access to multiple tenants - switch if needed
  </Accordion>
</AccordionGroup>
